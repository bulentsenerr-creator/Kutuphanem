<!DOCTYPE html>
<html lang="tr">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
 <meta name="apple-mobile-web-app-capable" content="yes" />
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
 <meta name="apple-mobile-web-app-title" content="KÃ¼tÃ¼phanem" />
 <meta name="mobile-web-app-capable" content="yes" />
 <meta name="theme-color" content="#2563eb" />
 <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png" />
 <!-- Manifest tek dosyada kalmasÄ± iÃ§in runtime'da Blob URL olarak atanÄ±r -->
 <link rel="manifest" id="manifestLink" href="" />
 <title>KÃ¼tÃ¼phanem Pro Max v2026.3.1</title>
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
 <style>
 :root {
 --primary: #2563eb; --bg: #f8fafc; --card: #ffffff;
 --text: #0f172a; --secondary: #64748b; --success: #10b981;
 }
 * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
 body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }
 .app-header {
 background: var(--card);
 padding: 16px;
 position: sticky; top: 0; z-index: 1000;
 box-shadow: 0 1px 3px rgba(0,0,0,0.05);
 display: flex; justify-content: space-between; align-items: center;
 }
 .app-header h1 { font-size: 1.1rem; margin: 0; color: var(--primary); font-weight: 800; }
 .header-icons { display: flex; gap: 20px; align-items: center; }
 .header-icons span, .header-icons label { font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
 .header-icons span:active, .header-icons label:active { transform: scale(0.95); }
 .stats-bar {
 background: var(--primary);
 color: white;
 padding: 10px 16px;
 font-size: 0.85rem;
 display: flex;
 justify-content: space-between;
 font-weight: 600;
 }
 .container { padding: 12px; max-width: 600px; margin: auto; }
 .card {
 background: var(--card);
 border-radius: 24px;
 padding: 20px;
 margin-bottom: 16px;
 box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
 border: 1px solid rgba(0,0,0,0.05);
 }
 .hidden { display: none; }
 input, select, textarea {
 width: 100%;
 padding: 14px;
 border: 2px solid #f1f5f9;
 border-radius: 14px;
 font-size: 16px;
 margin-bottom: 12px;
 background: #f8fafc;
 transition: all 0.3s ease;
 }
 .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
 button {
 border: none; border-radius: 14px; font-weight: 700; cursor: pointer;
 padding: 14px; transition: 0.3s; font-size: 14px;
 }
 .btn-primary {
 background: var(--primary);
 color: white;
 box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
 width: 100%;
 }
 .shelf-container { overflow-x: auto; display: flex; gap: 10px; padding: 10px 0; scrollbar-width: none; }
 .shelf-container::-webkit-scrollbar { display: none; }
 .tab {
 padding: 10px 20px;
 background: white;
 border: 2px solid #f1f5f9;
 border-radius: 30px;
 white-space: nowrap;
 font-size: 13px;
 font-weight: 700;
 color: var(--secondary);
 cursor: pointer;
 }
 .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
 .book-card {
 background: var(--card);
 border-radius: 20px;
 padding: 15px;
 margin-bottom: 15px;
 display: flex;
 gap: 15px;
 position: relative;
 border: 1px solid #f1f5f9;
 }
 .book-card img {
 width: 95px; height: 140px; object-fit: cover;
 border-radius: 12px;
 box-shadow: 0 8px 16px rgba(0,0,0,0.1);
 cursor: pointer;
 }
 .book-details { flex: 1; overflow: hidden; }
 .book-details h3 {
 margin: 0;
 font-size: 1.05rem;
 font-weight: 800;
 color: var(--text);
 line-height: 1.2;
 }
 .book-details p {
 margin: 3px 0;
 font-size: 0.85rem;
 color: var(--secondary);
 white-space: nowrap;
 overflow: hidden;
 text-overflow: ellipsis;
 }
 .format-badge {
 display: inline-block;
 padding: 4px 10px;
 background: #eff6ff;
 color: var(--primary);
 border-radius: 8px;
 font-size: 11px;
 font-weight: 800;
 margin-top: 6px;
 }
 /* Okuma durumu rozetleri */
 .status-badge {
 display: inline-block;
 padding: 4px 10px;
 border-radius: 8px;
 font-size: 11px;
 font-weight: 900;
 margin-top: 6px;
 margin-left: 8px;
 vertical-align: middle;
 border: 1px solid rgba(0,0,0,0.05);
 }
 .st-okunacak { background: #f1f5f9; color: #334155; }
 .st-okunuyor { background: #fff7ed; color: #9a3412; }
 .st-okundu   { background: #ecfdf5; color: #065f46; }
 .desc-overlay {
 display: none;
 position: absolute;
 inset: 0;
 background: rgba(255,255,255,0.98);
 padding: 20px;
 border-radius: 20px;
 font-size: 0.9rem;
 overflow-y: auto;
 z-index: 5;
 color: var(--text);
 border: 2px solid var(--primary);
 white-space: pre-wrap;
 line-height: 1.45;
 }
 .desc-overlay h4 {
 margin: 0 0 10px 0;
 color: var(--primary);
 font-size: 0.95rem;
 }
 .desc-overlay .muted {
 color: var(--secondary);
 font-size: 0.85rem;
 margin-bottom: 10px;
 }
 .mini-actions { display: flex; gap: 12px; align-items: center; justify-content: flex-end; }
 .mini-actions span { cursor: pointer; font-size: 1.05rem; }
 .mini-actions span:active { transform: scale(0.92); }
 .nav-bar { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 15px 10px 25px; border-top: 1px solid #f1f5f9; z-index: 2000; }
 .nav-item { flex: 1; text-align: center; color: var(--secondary); font-size: 11px; font-weight: 700; cursor: pointer; }
 #lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
 #lightbox img { max-width: 100%; max-height: 80vh; border-radius: 15px; }
 .tiny-note { color: var(--secondary); font-size: 12px; margin-top: -6px; margin-bottom: 12px; }

 /* --- Barkod modal --- */
 #scanModal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 4000; align-items: center; justify-content: center; padding: 18px; }
 .scan-card { background: #111827; color: #f8fafc; width: 96%; max-width: 620px; border-radius: 16px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
 .scan-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
 .scan-title { font-weight:800; font-size: 14px; color: #93c5fd; }
 .scan-controls { display:flex; gap:8px; align-items:center; margin: 8px 0 10px; }
 .scan-controls select, .scan-controls button, .scan-controls input[type=file]{ padding:8px; border-radius:10px; border:1px solid #1f2937; background:#0b1220; color:#e5e7eb; font-size:12px; }
 .scan-video-wrap { position: relative; border-radius: 12px; overflow: hidden; border:2px solid #1f2937; }
 .scan-video-wrap video { width: 100%; height: auto; background: #000; display:block; }
 .scan-aim { position:absolute; inset: 12% 10%; border: 2px dashed rgba(147,197,253,0.7); border-radius: 8px; box-shadow: 0 0 0 20000px rgba(0,0,0,0.15) inset; pointer-events:none; }
 .scan-footer { display:flex; justify-content:space-between; align-items:center; margin-top:8px; font-size: 12px; color:#93c5fd; }
 </style>
</head>
<body>
<header class="app-header">
 <h1>ğŸ“š KÃœTÃœPHANEM PRO MAX</h1>
 <div class="header-icons">
 <span onclick="exportData()" title="DÄ±ÅŸa Aktar / Yedek Al">ğŸ“¤</span>
 <label title="Ä°Ã§e Aktar / Geri YÃ¼kle">ğŸ“¥<input type="file" hidden onchange="importData(event)" /></label>
 <!-- Barkod tarama kÄ±sayolu -->
 <span onclick="openScanner()" title="Barkod Tara">ğŸ“·</span>
 </div>
</header>
<div class="stats-bar">
 <span id="statCount">0 Kitap</span>
 <span id="statValue">0.00 TL</span>
</div>
<div class="container">
 <div class="card" id="formCard">
 <div style="display:flex; gap:10px; margin-bottom:12px; align-items:center;">
 <input type="text" id="isbnSearch" inputmode="numeric" placeholder="ISBN No ile sorgula..." style="margin-bottom:0" />
 <button onclick="fetchBook()" class="btn-primary" style="padding:12px 20px; width:auto">Getir</button>
 <button onclick="openScanner()" title="Barkod Tara" style="padding:12px 14px; border-radius:14px; background:#111827; color:#e5e7eb;">ğŸ“·</button>
 </div>
 <div id="extraFields" class="hidden">
 <input type="text" id="title" placeholder="Kitap AdÄ± *" />
 <input type="text" id="author" placeholder="Yazar" />
 <input type="text" id="isbnFinal" placeholder="ISBN NumarasÄ±" />
 <div class="grid-2">
 <input type="text" id="publisher" placeholder="YayÄ±ncÄ±" />
 <input type="text" id="shelf" placeholder="Raf Konumu" />
 </div>
 <div class="grid-2">
 <input type="number" id="pubYear" placeholder="YayÄ±n YÄ±lÄ±" />
 <input type="number" id="pageCount" placeholder="Sayfa" />
 </div>
 <!-- Dil / Kategoriler / Notlar -->
 <div class="grid-2">
 <input type="text" id="language" placeholder="Dil (Ã¶rn: TÃ¼rkÃ§e / EN / TR)" />
 <input type="text" id="categories" placeholder="Kategoriler (virgÃ¼lle: roman, tarih...)" />
 </div>
 <textarea id="notes" placeholder="Notlar" rows="2"></textarea>
 <!-- Okuma Durumu -->
 <select id="status">
 <option value="Okunacak">ğŸ“Œ Okunacak</option>
 <option value="Okunuyor">ğŸ“– Okunuyor</option>
 <option value="Okundu">âœ… Okundu</option>
 </select>
 <select id="format">
 <option value="Ciltsiz">Ciltsiz</option>
 <option value="Ciltli">Ciltli</option>
 <option value="Deri Ciltli">Deri Ciltli</option>
 <option value="Defter">Defter</option>
 <option value="Kutulu Set">Kutulu Set</option>
 <option value="Geleneksel olmayan">Geleneksel olmayan</option>
 <option value="CD">CD</option>
 <option value="DVD">DVD</option>
 <option value="Ekitap">Ekitap</option>
 <option value="DiÄŸer">DiÄŸer</option>
 </select>
 <div class="grid-2">
 <input type="date" id="pDate" />
 <input type="number" id="price" step="0.01" placeholder="Fiyat" />
 </div>
 <textarea id="desc" placeholder="AÃ§Ä±klama" rows="3"></textarea>
 <input type="file" id="manualCover" accept="image/*" style="font-size:12px;" />
 <div class="tiny-note">ğŸ“Œ Manuel kapaklar otomatik IndexedDBâ€™ye kaydedilir (localStorage taÅŸmasÄ± Ã¶nlenir).</div>
 <input type="hidden" id="coverImg" />
 <button onclick="saveBook()" class="btn-primary" id="saveBtn">Kaydet</button>
 <button onclick="cancelEdit()" style="width:100%; background:none; margin-top:10px; color: var(--secondary);">VazgeÃ§</button>
 </div>
 <button onclick="toggleForm()" class="btn-primary" id="addBtn">HÄ±zlÄ± Kitap Ekle</button>
 </div>
 <div class="card" style="padding:12px;">
 <input type="text" id="liveSearch" placeholder="Ä°sim, Yazar, ISBN, Dil, Kategori, Not, Durum Ara..." oninput="render()" style="margin-bottom:10px;" />
 <select id="sort" onchange="render()" style="margin-bottom:0; font-size:14px; font-weight:600;">
 <option value="added_desc">En Yeni Eklenen</option>
 <option value="title_asc">Ä°sim (A-Z)</option>
 <option value="price_desc">Fiyat (PahalÄ±dan Ucuza)</option>
 <option value="year_desc">YayÄ±n YÄ±lÄ± (Yeni-Eski)</option>
 <option value="page_desc">Sayfa SayÄ±sÄ± (Ã‡ok-Az)</option>
 </select>
 </div>
 <div id="shelfTabs" class="shelf-container"></div>
 <div id="list"></div>
</div>
<nav class="nav-bar">
 <div class="nav-item" onclick="goHome()">ğŸ <br/>Ana Sayfa</div>
 <div class="nav-item" onclick="toggleForm()">â•<br/>Ekle</div>
 <div class="nav-item" onclick="exportData()">ğŸ“¤<br/>Yedek Al</div>
</nav>
<div id="lightbox" onclick="this.style.display='none'"><img id="lbImg" alt="Kapak" /></div>

<!-- Barkod Tarama Modal -->
<div id="scanModal" onclick="closeScanner(event)">
  <div class="scan-card" onclick="event.stopPropagation()">
    <div class="scan-header">
      <div class="scan-title">ğŸ“· Barkod Tara (ISBN/EANâ€‘13 destekli)</div>
      <button onclick="hideScanner()" style="background:#ef4444;color:#fff;padding:8px 10px;border-radius:10px;">Kapat</button>
    </div>
    <div class="scan-controls">
      <select id="camList"></select>
      <button onclick="startScan()" style="background:#16a34a;color:#fff;">BaÅŸlat</button>
      <button onclick="stopScan()" style="background:#f59e0b;color:#111827;">Durdur</button>
      <label style="display:inline-block;">
        <input type="file" id="barcodeImage" accept="image/*" style="display:none" onchange="scanFromImage(event)">
        <span style="padding:8px 10px;border-radius:10px;background:#0ea5e9;">ğŸ“ FotoÄŸraftan Tara</span>
      </label>
      <button onclick="toggleTorch()" id="torchBtn" style="display:none;">ğŸ”¦ IÅŸÄ±k</button>
    </div>
    <div class="scan-video-wrap">
      <video id="preview" playsinline muted></video>
      <div class="scan-aim"></div>
    </div>
    <div class="scan-footer">
      <span id="scanInfo">HazÄ±r</span>
      <span id="scanLast"></span>
    </div>
  </div>
</div>

<script>
/*** Manifest ***/
(function setupManifest() {
  try {
    const manifest = {
      name: 'KÃ¼tÃ¼phanem Pro Max', short_name: 'KÃ¼tÃ¼phanem', start_url: './', display: 'standalone',
      background_color: '#f8fafc', theme_color: '#2563eb',
      icons: [{ src: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png', sizes: '512x512', type: 'image/png' }]
    };
    const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
    const url = URL.createObjectURL(blob);
    const link = document.getElementById('manifestLink');
    if (link) link.href = url;
  } catch (e) { console.warn('Manifest oluÅŸturulamadÄ±:', e); }
})();
/*** SW ***/
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    try {
      const swCode = `
      const CACHE = 'kutuphanem-pro-max-v2026-3-1';
      self.addEventListener('install', (e) => {
        e.waitUntil((async () => { const c = await caches.open(CACHE); try { await c.addAll(['./']); } catch(err) {} self.skipWaiting(); })());
      });
      self.addEventListener('activate', (e) => {
        e.waitUntil((async () => { const keys = await caches.keys(); await Promise.all(keys.map(k => (k !== CACHE ? caches.delete(k) : null))); self.clients.claim(); })());
      });
      self.addEventListener('fetch', (event) => {
        const req = event.request; event.respondWith((async () => { const cached = await caches.match(req); if (cached) return cached; try { const fresh = await fetch(req); const c = await caches.open(CACHE); c.put(req, fresh.clone()); return fresh; } catch(e) { return cached || new Response('', {status: 503, statusText: 'Offline'}); } })());
      });`;
      const blob = new Blob([swCode], { type: 'text/javascript' });
      navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
    } catch(e) {}
  });
}
/*** Data / Keys ***/
const STORAGE_KEY = 'pro_lib_v12';
const OLD_KEY = 'pro_lib_v11';
const $ = id => document.getElementById(id);
const PLACEHOLDER = 'https://via.placeholder.com/150x200?text=Kapak+Yok';
let db = [];
let editingId = null;
let currentShelf = 'TÃ¼mÃ¼';
/*** IDB (Covers) ***/
const IDB_NAME = 'kutuphanem_pro_max';
const IDB_VER = 1;
const STORE_COVERS = 'covers';
let idbPromise = null;
const coverUrlCache = new Map();
function openIDB(){ if (idbPromise) return idbPromise; idbPromise = new Promise((resolve, reject)=>{ const req = indexedDB.open(IDB_NAME, IDB_VER); req.onupgradeneeded=()=>{ const db=req.result; if(!db.objectStoreNames.contains(STORE_COVERS)) db.createObjectStore(STORE_COVERS); }; req.onsuccess=()=>resolve(req.result); req.onerror=()=>reject(req.error); }); return idbPromise; }
async function idbPutCover(key, blob){ const dbi = await openIDB(); return new Promise((resolve, reject)=>{ const tx = dbi.transaction(STORE_COVERS,'readwrite'); tx.objectStore(STORE_COVERS).put(blob, key); tx.oncomplete=()=>resolve(true); tx.onerror=()=>reject(tx.error); }); }
async function idbGetCover(key){ const dbi = await openIDB(); return new Promise((resolve, reject)=>{ const tx = dbi.transaction(STORE_COVERS,'readonly'); const req = tx.objectStore(STORE_COVERS).get(key); req.onsuccess=()=>resolve(req.result || null); req.onerror=()=>reject(req.error); }); }
async function idbDelCover(key){ const dbi = await openIDB(); return new Promise((resolve, reject)=>{ const tx = dbi.transaction(STORE_COVERS,'readwrite'); tx.objectStore(STORE_COVERS).delete(key); tx.oncomplete=()=>resolve(true); tx.onerror=()=>reject(tx.error); }); }
function revokeCoverUrl(key){ if(coverUrlCache.has(key)){ try{ URL.revokeObjectURL(coverUrlCache.get(key)); }catch(e){} coverUrlCache.delete(key); } }
function newCoverKey(){ return 'c_'+Date.now()+'_'+Math.random().toString(16).slice(2); }
async function dataUrlToBlob(dataUrl){ const res = await fetch(dataUrl); return await res.blob(); }
async function blobToDataUrl(blob){ return new Promise((resolve)=>{ const r = new FileReader(); r.onload=()=>resolve(r.result); r.readAsDataURL(blob); }); }
async function ensureCoverSrc(book){ if(!book || !book.coverKey) return null; const key = book.coverKey; if(coverUrlCache.has(key)) return coverUrlCache.get(key); const blob = await idbGetCover(key); if(!blob) return null; const url = URL.createObjectURL(blob); coverUrlCache.set(key, url); return url; }
/*** Utils ***/
function escapeHTML(str){ return (str ?? '').toString().replaceAll('&','&').replaceAll('<','<').replaceAll('>','>').replaceAll('"','"').replaceAll("'",'&#039;'); }
function htmlToText(maybeHtml){ const s=(maybeHtml ?? '').toString(); if(!s) return ''; if(!(s.includes('<') && s.includes('>'))) return s; try{ const doc = new DOMParser().parseFromString(s,'text/html'); doc.querySelectorAll('br').forEach(br=>br.replaceWith('\n')); doc.querySelectorAll('p').forEach(p=>p.append('\n')); return (doc.body.textContent || '').replace(/\n{3,}/g,'\n\n').trim(); }catch(e){ return s; } }
function statusClass(st){ if(st==='Okundu') return 'st-okundu'; if(st==='Okunuyor') return 'st-okunuyor'; return 'st-okunacak'; }
function normalizeBook(b){ const nb = { id: b.id || Date.now(), title: b.title || '', author: b.author || '', isbn: b.isbn || '', publisher: b.publisher || '', pubYear: Number.isFinite(b.pubYear)? b.pubYear : (parseInt(b.pubYear)||0), pageCount: Number.isFinite(b.pageCount)? b.pageCount : (parseInt(b.pageCount)||0), shelf: (b.shelf||'RafsÄ±z').toString().trim() || 'RafsÄ±z', format: b.format || 'Ciltsiz', price: Number.isFinite(b.price)? b.price : (parseFloat(b.price)||0), pDate: b.pDate || '', desc: b.desc || '', img: b.img || '', coverKey: b.coverKey || null, language: b.language || '', categories: Array.isArray(b.categories)? b.categories : (typeof b.categories==='string'? b.categories.split(',').map(x=>x.trim()).filter(Boolean):[]), notes: b.notes || '', status: b.status || 'Okunacak', addedAt: b.addedAt || new Date().getTime() }; if(!nb.img && !nb.coverKey) nb.img = PLACEHOLDER; return nb; }
function loadDB(){ let raw = localStorage.getItem(STORAGE_KEY); if(!raw) raw = localStorage.getItem(OLD_KEY); try{ const parsed = raw ? JSON.parse(raw) : []; db = Array.isArray(parsed)? parsed.map(normalizeBook) : []; } catch(e){ db = []; } localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
function saveDB(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
/*** Nav / Form ***/
function goHome(){ currentShelf='TÃ¼mÃ¼'; $('liveSearch').value=''; render(); window.scrollTo({top:0, behavior:'smooth'}); }
function toggleForm(){ $('extraFields').classList.toggle('hidden'); $('addBtn').classList.toggle('hidden'); }
function cancelEdit(){ editingId = null; resetForm(); if(!$('extraFields').classList.contains('hidden')) toggleForm(); }
function setShelf(s){ currentShelf = s; render(); }
/*** ISBN Fetch ***/
async function fetchBook(){ const raw = $('isbnSearch').value; const isbn = raw.replace(/\D/g,''); if(!isbn){ alert('ISBN girilmedi.'); return; } const prev = $('isbnSearch').value; $('isbnSearch').value = 'SorgulanÄ±yor...'; try { const r = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`); const d = await r.json(); if(d.items && d.items.length){ const i = d.items[0].volumeInfo; if($('extraFields').classList.contains('hidden')) toggleForm(); $('title').value = i.title || ''; $('author').value = i.authors ? i.authors.join(', ') : ''; $('isbnFinal').value = isbn; $('publisher').value = i.publisher || ''; $('pubYear').value = i.publishedDate ? (i.publishedDate.split('-')[0] || '') : ''; $('pageCount').value = i.pageCount || ''; $('desc').value = i.description || ''; $('language').value = i.language ? i.language.toUpperCase() : ''; $('categories').value = Array.isArray(i.categories) ? i.categories.join(', ') : ''; $('notes').value = ''; $('status').value = 'Okunacak'; let thumb = i.imageLinks ? (i.imageLinks.thumbnail || i.imageLinks.smallThumbnail) : ''; if(!thumb){ // OpenLibrary fallback
   const ol = await tryOpenLibCover(isbn); thumb = ol || ''; }
 $('coverImg').value = thumb ? thumb.replace('http:','https:') : ''; $('isbnSearch').value = isbn; }
 else { alert('BulunamadÄ±.'); $('isbnSearch').value = prev.replace('SorgulanÄ±yor...','') || isbn; }
 } catch(e){ alert('BaÄŸlantÄ± HatasÄ±!'); $('isbnSearch').value = prev.replace('SorgulanÄ±yor...','') || isbn; }
}
async function tryOpenLibCover(isbn){ try{ const u = `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`; // basit kontrol - HEAD yerine fetch ve status kontrolÃ¼
 const res = await fetch(u, { method:'GET' }); if(res.ok){ return u; } return ''; } catch(e){ return ''; } }
/*** Manual Cover Resize ***/
$('manualCover').addEventListener('change', function(e){ const file = e.target.files && e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(event){ const img = new Image(); img.src = event.target.result; img.onload = function(){ const canvas = document.createElement('canvas'); const maxW = 400; const scale = Math.min(1, maxW/img.width); canvas.width = Math.round(img.width*scale); canvas.height = Math.round(img.height*scale); const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,canvas.width,canvas.height); $('coverImg').value = canvas.toDataURL('image/jpeg', 0.82); }; }; reader.readAsDataURL(file); });
/*** Save / Edit / Delete ***/
async function saveBook(){ const title = $('title').value.trim(); if(!title) return alert('Kitap adÄ± zorunlu.'); const existing = editingId ? db.find(x=>x.id===editingId) : null; const prev = existing ? normalizeBook(existing) : null; let coverVal = ($('coverImg').value || '').trim(); let imgUrl = ''; let coverKey = null; try { if(!coverVal){ if(prev){ coverKey = prev.coverKey || null; imgUrl = prev.img || ''; if(!coverKey && !imgUrl) imgUrl = PLACEHOLDER; } else { imgUrl = PLACEHOLDER; } } else if(/^data:image\//i.test(coverVal)){ const key = newCoverKey(); const blob = await dataUrlToBlob(coverVal); await idbPutCover(key, blob); coverKey = key; imgUrl = ''; } else { imgUrl = coverVal; coverKey = null; } } catch(e){ console.warn('Kapak kaydÄ± hatasÄ±:', e); if(prev){ coverKey = prev.coverKey || null; imgUrl = prev.img || PLACEHOLDER; } else { imgUrl = PLACEHOLDER; } }
 const book = normalizeBook({ id: editingId || Date.now(), title, author: $('author').value || '', isbn: $('isbnFinal').value || '', publisher: $('publisher').value || '', pubYear: parseInt($('pubYear').value) || 0, pageCount: parseInt($('pageCount').value) || 0, shelf: ($('shelf').value || '').trim() || 'RafsÄ±z', format: $('format').value, price: parseFloat($('price').value) || 0, pDate: $('pDate').value || '', desc: $('desc').value || '', language: ($('language').value || '').trim(), categories: ($('categories').value || '').split(',').map(x=>x.trim()).filter(Boolean), notes: $('notes').value || '', status: $('status').value || 'Okunacak', img: imgUrl || '', coverKey, addedAt: editingId ? (prev?.addedAt || new Date().getTime()) : new Date().getTime() });
 if(editingId && prev && prev.coverKey && prev.coverKey !== book.coverKey){ await idbDelCover(prev.coverKey).catch(()=>{}); revokeCoverUrl(prev.coverKey); }
 if(editingId) db = db.map(b => (b.id===editingId ? book : b)); else db.push(book);
 saveDB(); editingId = null; if(!$('extraFields').classList.contains('hidden')) toggleForm(); resetForm(); render(); }
function editBook(id){ const b0 = db.find(x=>x.id===id); if(!b0) return; const b = normalizeBook(b0); editingId = id; if($('extraFields').classList.contains('hidden')) toggleForm(); $('title').value = b.title || ''; $('author').value = b.author || ''; $('isbnFinal').value = b.isbn || ''; $('publisher').value = b.publisher || ''; $('pubYear').value = b.pubYear || 0; $('pageCount').value = b.pageCount || 0; $('shelf').value = b.shelf || 'RafsÄ±z'; $('format').value = b.format || 'Ciltsiz'; $('price').value = (b.price || 0); $('pDate').value = b.pDate || ''; $('desc').value = b.desc || ''; $('language').value = b.language || ''; $('categories').value = (b.categories && b.categories.length) ? b.categories.join(', ') : ''; $('notes').value = b.notes || ''; $('status').value = b.status || 'Okunacak'; $('coverImg').value = (b.img && b.img !== PLACEHOLDER) ? b.img : ''; window.scrollTo({top:0, behavior:'smooth'}); }
async function delBook(id){ if(!confirm('Silinsin mi?')) return; const b0 = db.find(x=>x.id===id); const b = b0 ? normalizeBook(b0) : null; db = db.filter(x=>x.id!==id); saveDB(); if(b && b.coverKey){ await idbDelCover(b.coverKey).catch(()=>{}); revokeCoverUrl(b.coverKey); } render(); }
function resetForm(){ document.querySelectorAll('#extraFields input, #extraFields textarea, #extraFields select').forEach(el=>{ if(el.type==='file') el.value=''; else el.value=''; }); $('format').value='Ciltsiz'; $('status').value='Okunacak'; $('coverImg').value=''; $('isbnSearch').value=''; }
function showLb(src){ $('lbImg').src = src; $('lightbox').style.display='flex'; }
function toggleDesc(id){ const el = document.getElementById('desc-'+id); if(!el) return; el.style.display = (el.style.display==='block') ? 'none' : 'block'; }
/*** Export / Import ***/
async function exportData(){ const uniqueKeys=[...new Set(db.map(b=>b.coverKey).filter(Boolean))]; const covers={}; for(const key of uniqueKeys){ try{ const blob = await idbGetCover(key); if(blob) covers[key] = await blobToDataUrl(blob); } catch(e){ console.warn('Kapak export edilemedi:', key, e); } } const payload = { meta:{ app:'KÃ¼tÃ¼phanem Pro Max', version:'v2026.3.1', exportedAt:new Date().toISOString() }, books: db, covers }; const blob = new Blob([JSON.stringify(payload)], { type:'application/json' }); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='yedek.json'; a.click(); }
async function importData(e){ const f = e.target.files && e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = async (re)=>{ try{ const parsed = JSON.parse(re.target.result); let incomingBooks=[]; let incomingCovers={}; if(Array.isArray(parsed)){ incomingBooks = parsed.map(normalizeBook); } else { incomingBooks = Array.isArray(parsed.books)? parsed.books.map(normalizeBook):[]; incomingCovers = (parsed.covers && typeof parsed.covers==='object') ? parsed.covers : {}; } const coverKeys = Object.keys(incomingCovers||{}); for(const key of coverKeys){ try{ const dataUrl = incomingCovers[key]; if(typeof dataUrl==='string' && /^data:image\//i.test(dataUrl)){ const blob = await dataUrlToBlob(dataUrl); await idbPutCover(key, blob); revokeCoverUrl(key); } } catch(err){ console.warn('Kapak import edilemedi:', key, err); } } db = incomingBooks; saveDB(); render(); alert('Yedek yÃ¼klendi âœ…'); } catch(err){ alert('GeÃ§ersiz yedek dosyasÄ±!'); console.error(err); } }; r.readAsText(f); }
/*** Render ***/
async function render(){ const term = ($('liveSearch').value || '').toLowerCase(); const sort = $('sort').value; const shelves = ['TÃ¼mÃ¼', ...new Set(db.map(b => (b.shelf || 'RafsÄ±z')) )]; $('shelfTabs').innerHTML = shelves.map(s => { const active = (currentShelf===s)? 'active' : ''; return `<div class="tab ${active}" onclick='setShelf(${JSON.stringify(s)})'>${escapeHTML(s)}</div>`; }).join(''); let filtered = db.map(normalizeBook).filter(b => { const mShelf = (currentShelf === 'TÃ¼mÃ¼' || b.shelf === currentShelf); if(!mShelf) return false; if(!term) return true; const hay = [ (b.title||''), (b.author||''), (b.isbn||''), (b.language||''), (b.categories||[]).join(' '), (b.notes||''), (b.status||'') ].join(' ').toLowerCase(); return hay.includes(term); }); filtered.sort((a,b)=>{ if (sort==='title_asc') return (a.title||'').localeCompare(b.title||''); if (sort==='price_desc') return (b.price||0) - (a.price||0); if (sort==='year_desc') return (b.pubYear||0) - (a.pubYear||0); if (sort==='page_desc') return (b.pageCount||0) - (a.pageCount||0); return (b.addedAt||0) - (a.addedAt||0); }); $('list').innerHTML = filtered.map(b => { const safeTitle = escapeHTML(b.title); const safeAuthor = escapeHTML(b.author || '-'); const safePublisher = escapeHTML(b.publisher || '-'); const safeShelf = escapeHTML(b.shelf || 'RafsÄ±z'); const safeLang = escapeHTML(b.language || '-'); const safeCats = escapeHTML((b.categories && b.categories.length) ? b.categories.join(' â€¢ ') : '-'); const safeIsbn = escapeHTML(b.isbn || '-'); const safeStatus = escapeHTML(b.status || 'Okunacak'); const price = (Number(b.price)||0).toFixed(2); const page = Number(b.pageCount)||0; const imgSrc = escapeHTML(b.img || PLACEHOLDER); const descText = (b.desc || '').trim(); const notesText = (b.notes || '').trim(); const overlay = `
 <h4>ğŸ“Œ AÃ§Ä±klama / Notlar</h4>
 <div class="muted">Raf: ${safeShelf} â€¢ Dil: ${safeLang} â€¢ Durum: <b>${safeStatus}</b></div>
 <div><b>AÃ§Ä±klama:</b>\n${escapeHTML(htmlToText(descText) || 'AÃ§Ä±klama yok.')}</div>
 <div style="margin-top:10px;"><b>Notlar:</b>\n${escapeHTML(notesText || 'Not yok.')}</div>`; return `
 <div class="book-card" ondblclick="toggleDesc(${b.id})">
 <div class="desc-overlay" id="desc-${b.id}" onclick="toggleDesc(${b.id})">${overlay}</div>
 <img id="img-${b.id}" src="${imgSrc}" onclick="showLb(document.getElementById('img-${b.id}').src)" alt="Kapak" />
 <div class="book-details">
 <h3>${safeTitle}</h3>
 <p>ğŸ‘¤ ${safeAuthor}</p>
 <p>ğŸ¢ ${safePublisher} â€¢ ğŸ“„ ${page}</p>
 <p>ğŸ†” ISBN: ${safeIsbn}</p>
 <p>ğŸŒ ${safeLang} â€¢ ğŸ·ï¸ ${safeCats}</p>
 <div>
 <span class="format-badge">${escapeHTML(b.format || 'Ciltsiz')}</span>
 <span class="status-badge ${statusClass(b.status)}">${safeStatus}</span>
 </div>
 <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
 <span style="color:var(--success); font-weight:800">${price} TL</span>
 <div class="mini-actions">
 <span title="Bilgi/Not" onclick="toggleDesc(${b.id})">â„¹ï¸</span>
 <span title="DÃ¼zenle" onclick="editBook(${b.id})">âœï¸</span>
 <span title="Sil" onclick="delBook(${b.id})">ğŸ—‘ï¸</span>
 </div>
 </div>
 </div>
 </div>`; }).join(''); $('statCount').innerText = `${db.length} Kitap`; $('statValue').innerText = `${db.reduce((s,b)=> s + (parseFloat(b.price)||0), 0).toFixed(2)} TL`; for (const b of filtered){ if(!b.coverKey) continue; try{ const src = await ensureCoverSrc(b); if(src){ const imgEl = document.getElementById('img-'+b.id); if(imgEl) imgEl.src = src; } } catch(e){} }
}
/*** Migrate big dataURL covers to IDB ***/
async function migrateLargeDataUrlCovers(){ const THRESH=120000; let changed=false; for(let i=0;i<db.length;i++){ const b = normalizeBook(db[i]); if(b.coverKey) continue; if(b.img && /^data:image\//i.test(b.img) && b.img.length>THRESH){ try{ const key=newCoverKey(); const blob=await dataUrlToBlob(b.img); await idbPutCover(key, blob); b.coverKey=key; b.img=''; db[i]=b; changed=true; } catch(e){ console.warn('Migrasyon baÅŸarÄ±sÄ±z:', e); } } } if(changed) saveDB(); }
/*** Init ***/
(async function init(){ loadDB(); await migrateLargeDataUrlCovers(); render(); })();

/* =====================
   BARKOD TARAMA MODÃœLÃœ
   ===================== */
let codeReader = null; let currentDeviceId = null; let streamRef = null; let trackRef = null; let torchOn = false; let _scanStopRequested = false;
function openScanner(){ $('scanModal').style.display='flex'; $('scanInfo').textContent='Kamera hazÄ±rlanÄ±yor...'; loadZXing().then(listCameras).then(()=>startScan()).catch(err=>{ $('scanInfo').textContent='Kamera eriÅŸimi reddedildi veya bulunamadÄ±.'; console.error(err); }); }
function hideScanner(){ stopScan(); $('scanModal').style.display='none'; }
function closeScanner(e){ if(e && e.target && e.target.id==='scanModal'){ hideScanner(); } }
async function loadZXing(){ if(window.ZXing && (ZXing.BrowserMultiFormatReader || ZXing.BrowserBarcodeReader)) return; return new Promise((resolve, reject)=>{ const s1=document.createElement('script'); s1.src='https://unpkg.com/@zxing/library@0.20.0'; s1.onload=()=>resolve(); s1.onerror=()=>reject(new Error('ZXing yÃ¼klenemedi')); document.head.appendChild(s1); }); }
async function listCameras(){ try{ if(!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) throw new Error('enumerateDevices yok'); const devices = await navigator.mediaDevices.enumerateDevices(); const vids = devices.filter(d=>d.kind==='videoinput'); const camSel = $('camList'); camSel.innerHTML = vids.map((d,i)=>`<option value="${d.deviceId}">${d.label || 'Kamera '+(i+1)}</option>`).join(''); if(vids.length>0){ currentDeviceId = vids[vids.length-1].deviceId; camSel.value = currentDeviceId; camSel.onchange = ()=>{ currentDeviceId = camSel.value; startScan(); }; } else { $('scanInfo').textContent = 'Kamera bulunamadÄ±'; }
 } catch(e){ console.warn(e); }
}
async function startScan(){ try{ stopScan(); _scanStopRequested = false; $('scanInfo').textContent='TaranÄ±yor...'; const constraints = { video: { deviceId: currentDeviceId ? { exact: currentDeviceId } : undefined, facingMode: currentDeviceId? undefined : 'environment' } }; const stream = await navigator.mediaDevices.getUserMedia(constraints); streamRef = stream; const video = $('preview'); video.srcObject = stream; await video.play(); const tracks = stream.getVideoTracks(); trackRef = tracks && tracks[0]; try{ const caps = trackRef.getCapabilities?.(); if(caps && caps.torch){ $('torchBtn').style.display='inline-block'; } else { $('torchBtn').style.display='none'; } } catch(e){}
 // ZXing reader
 const Reader = ZXing.BrowserMultiFormatReader || ZXing.BrowserBarcodeReader; codeReader = new Reader(); const hints = new ZXing.Map(); const formats = [ ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.UPC_A, ZXing.BarcodeFormat.UPC_E, ZXing.BarcodeFormat.QR_CODE, ZXing.BarcodeFormat.CODE_128 ]; hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
 const decodeLoop = async ()=>{
   if(_scanStopRequested) return; try{ const result = await codeReader.decodeOnceFromVideoDevice(currentDeviceId || null, 'preview'); if(result && result.getText){ onScanResult(result.getText()); } } catch(err){ // continue loop on failure
   setTimeout(()=>{ if(!_scanStopRequested) decodeLoop(); }, 200);
 }
 };
 decodeLoop();
 } catch(e){ $('scanInfo').textContent='Kamera baÅŸlatÄ±lamadÄ±'; console.error(e); }
}
function stopScan(){ try{ _scanStopRequested = true; if(codeReader && codeReader.reset) codeReader.reset(); }catch(e){} try{ if(trackRef) trackRef.stop(); if(streamRef) streamRef.getTracks().forEach(t=>t.stop()); }catch(e){} trackRef=null; streamRef=null; }
async function toggleTorch(){ try{ if(!trackRef) return; const caps = trackRef.getCapabilities?.(); if(!(caps && caps.torch)) return; torchOn = !torchOn; await trackRef.applyConstraints({ advanced: [{ torch: torchOn }] }); $('torchBtn').textContent = torchOn ? 'ğŸ”¦ IÅŸÄ±k (AÃ§Ä±k)' : 'ğŸ”¦ IÅŸÄ±k'; } catch(e){ console.warn('Torch desteklenmiyor'); }
}
function onScanResult(text){ $('scanLast').textContent = 'Son: '+text; const isbn = extractIsbn(text); if(isbn){ $('isbnSearch').value = isbn; $('scanInfo').textContent = 'ISBN bulundu: '+isbn; hideScanner(); fetchBook(); beep(); } else { $('scanInfo').textContent = 'Kod okundu fakat ISBN bulunamadÄ±'; beep(440, 120); }
}
function extractIsbn(txt){ const s = (txt||'').toString().trim(); const num = s.replace(/\D/g,''); if(num.length===13 && (num.startsWith('978')||num.startsWith('979'))) return num; if(num.length===10){ return isbn10to13(num); }
 // Try URL param isbn=xxxx
 try { const u = new URL(s); const q = u.searchParams.get('isbn') || u.searchParams.get('ISBN'); if(q){ return q.replace(/\D/g,''); } } catch(e){}
 return null; }
function isbn10to13(isbn10){ try{ const core = '978' + isbn10.slice(0,9); let sum = 0; for(let i=0;i<12;i++){ sum += parseInt(core[i],10) * (i%2===0 ? 1 : 3); } const check = (10 - (sum % 10)) % 10; return core + String(check); } catch(e){ return null; } }
function beep(freq=880, dur=80){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.value=freq; o.type='triangle'; o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur/1000); setTimeout(()=>{ o.stop(); ctx.close(); }, dur+20); } catch(e){}
}
async function scanFromImage(e){ const file = e.target.files && e.target.files[0]; if(!file) return; $('scanInfo').textContent='Resim analiz ediliyor...'; const img = new Image(); img.onload = async ()=>{ try{ const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height; const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0); const dataUrl = canvas.toDataURL('image/png'); await loadZXing(); const Reader = ZXing.BrowserMultiFormatReader || ZXing.BrowserBarcodeReader; const reader = new Reader(); const res = await reader.decodeFromImageUrl(dataUrl); if(res && res.getText){ onScanResult(res.getText()); } else { $('scanInfo').textContent='Barkod bulunamadÄ±'; beep(440, 120); } } catch(err){ $('scanInfo').textContent='Ã‡Ã¶zÃ¼mlenemedi'; console.error(err); } };
 const fr = new FileReader(); fr.onload = (ev)=>{ img.src = ev.target.result; }; fr.readAsDataURL(file); }
</script>
<!-- ZXing kÃ¼tÃ¼phanesini dinamik yÃ¼kleyerek ekledik. Ä°sterse aÅŸaÄŸÄ±daki CDN'i statik olarak da ekleyebilirsiniz: -->
<!-- <script src="https://unpkg.com/@zxing/library@0.20.0"></script> -->
</body>
</html>
